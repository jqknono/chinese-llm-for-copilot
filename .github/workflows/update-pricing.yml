name: Update Provider Pricing

on:
  schedule:
    - cron: "0 2 * * 0"
  workflow_dispatch:

jobs:
  update-pricing:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Fetch latest provider pricing
        run: npm run pricing:fetch

      - name: Detect Aliyun parsing failure
        id: aliyun_failure
        run: |
          node -e "const fs=require('node:fs');const data=JSON.parse(fs.readFileSync('assets/provider-pricing.json','utf8'));const failures=Array.isArray(data.failures)?data.failures:[];const aliyunFailures=failures.map(String).filter((msg)=>/Unable to (parse|locate).*Aliyun/i.test(msg));const out=process.env.GITHUB_OUTPUT;fs.appendFileSync(out,'has_failure='+(aliyunFailures.length>0)+'\n');if(aliyunFailures.length>0){const message=aliyunFailures.join(' | ').replace(/\r?\n/g,' ').trim();fs.appendFileSync(out,'failure_message='+message+'\n');}"

      - name: Create issue for Aliyun parsing failure
        if: steps.aliyun_failure.outputs.has_failure == 'true'
        uses: actions/github-script@v7
        env:
          FAILURE_MESSAGE: ${{ steps.aliyun_failure.outputs.failure_message }}
        with:
          script: |
            const marker = '<!-- auto-pricing-aliyun-parse-failure -->';
            const title = '抓取失败：Unable to parse Aliyun coding plans';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const failureMessage = process.env.FAILURE_MESSAGE || 'Unable to parse Aliyun coding plans';
            const body = `${marker}
            阿里云百炼的 coding 套餐页面可能已变更，自动抓取出现解析失败。

            - 失败信息：\`${failureMessage}\`
            - 工作流运行：${runUrl}
            - 时间（UTC）：${new Date().toISOString()}

            @jqknono 请检查页面结构并更新解析逻辑。`;

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            const existing = issues.find((issue) =>
              !issue.pull_request &&
              issue.title === title &&
              typeof issue.body === 'string' &&
              issue.body.includes(marker),
            );

            if (existing) {
              core.info(`Aliyun parsing issue already open: #${existing.number}`);
              return;
            }

            const created = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
            core.info(`Created issue #${created.data.number}`);

      - name: Commit pricing changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/provider-pricing.json
          if git diff --cached --quiet; then
            echo "No pricing changes detected."
            exit 0
          fi
          git commit -m "chore: update provider pricing"
          git push
